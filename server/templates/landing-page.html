<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SecureClaw — Autonomous AI</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#0D1117;--surface:#161B22;--surface2:#1C2333;--border:#30363D;--text:#E6EDF3;--muted:#8B949E;--emerald:#00D9A6;--emerald-dim:rgba(0,217,166,.15);--red:#F85149;--font:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap');
    body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    .app{display:flex;height:100vh;overflow:hidden}
    .sidebar{width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
    .sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .logo{width:32px;height:32px;background:var(--emerald);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:14px}
    .sidebar-title{font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:16px}
    .sidebar-nav{flex:1;overflow-y:auto;padding:12px}
    .nav-section{margin-bottom:20px}
    .nav-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);padding:8px 12px;font-weight:600}
    .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all .15s;font-size:14px;color:var(--muted)}
    .nav-item:hover,.nav-item.active{background:var(--emerald-dim);color:var(--emerald)}
    .nav-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0}
    .nav-item.active .nav-dot{background:var(--emerald);box-shadow:0 0 8px var(--emerald)}
    .status-bar{padding:16px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .status-dot.online{background:#3FB950}
    .main{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .main-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface)}
    .main-title{font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:18px;display:flex;align-items:center;gap:8px}
    .agent-badge{font-size:11px;padding:3px 8px;border-radius:12px;background:var(--emerald-dim);color:var(--emerald);font-weight:500}
    .panel{display:none;flex:1;flex-direction:column;overflow:hidden}
    .panel.active{display:flex}
    .chat-messages{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px}
    .msg{max-width:75%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.6;word-wrap:break-word;white-space:pre-wrap}
    .msg.user{align-self:flex-end;background:var(--emerald);color:var(--bg);border-bottom-right-radius:4px}
    .msg.assistant{align-self:flex-start;background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px}
    .msg.error{align-self:flex-start;background:rgba(248,81,73,.1);border:1px solid var(--red);color:var(--red)}
    .msg .agent-tag{font-size:11px;color:var(--emerald);margin-bottom:4px;font-weight:600}
    .msg .tool-tag{font-size:11px;color:var(--muted);margin-top:6px;padding-top:6px;border-top:1px solid var(--border)}
    .chat-input-area{padding:16px 24px;border-top:1px solid var(--border);background:var(--surface)}
    .chat-input-row{display:flex;gap:10px;align-items:flex-end}
    .chat-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 16px;color:var(--text);font-size:14px;font-family:var(--font);resize:none;outline:none;max-height:120px;min-height:44px}
    .chat-input:focus{border-color:var(--emerald)}
    .chat-input::placeholder{color:var(--muted)}
    .send-btn{width:44px;height:44px;border-radius:12px;border:none;background:var(--emerald);color:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:opacity .15s;flex-shrink:0}
    .send-btn:hover{opacity:.85}
    .send-btn:disabled{opacity:.4;cursor:not-allowed}
    .send-btn svg{width:20px;height:20px}
    .typing{display:flex;gap:4px;padding:12px 16px;align-self:flex-start}
    .typing span{width:8px;height:8px;border-radius:50%;background:var(--muted);animation:bounce .6s infinite alternate}
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes bounce{to{transform:translateY(-6px);opacity:.4}}
    .welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:var(--muted);text-align:center;padding:40px}
    .welcome-icon{width:64px;height:64px;border-radius:20px;background:var(--emerald-dim);display:flex;align-items:center;justify-content:center}
    .welcome-icon svg{width:32px;height:32px;color:var(--emerald)}
    .welcome h2{font-family:'Space Grotesk',sans-serif;color:var(--text);font-size:22px}
    .welcome p{max-width:400px;font-size:14px;line-height:1.5}
    .dashboard{flex:1;overflow-y:auto;padding:24px}
    .dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px}
    .card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:20px}
    .card-title{font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:15px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .card-title .dot{width:8px;height:8px;border-radius:50%;background:var(--emerald)}
    .card-body{font-size:13px;color:var(--muted);line-height:1.6}
    .card-body .stat{font-size:28px;font-weight:700;color:var(--text);font-family:'Space Grotesk',sans-serif}
    .tool-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .tool-chip{font-size:11px;padding:4px 8px;background:var(--emerald-dim);color:var(--emerald);border-radius:6px}
    .task-list{display:flex;flex-direction:column;gap:8px}
    .task-item{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--surface);border-radius:8px;border:1px solid var(--border)}
    .task-item .task-info{display:flex;flex-direction:column;gap:2px}
    .task-item .task-name{font-size:13px;font-weight:500}
    .task-item .task-cron{font-size:11px;color:var(--muted)}
    .run-btn{padding:6px 14px;border-radius:6px;border:1px solid var(--emerald);background:transparent;color:var(--emerald);font-size:12px;cursor:pointer;font-weight:500;transition:all .15s}
    .run-btn:hover{background:var(--emerald);color:var(--bg)}
    .run-btn:disabled{opacity:.4;cursor:not-allowed}
    .template-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin-top:12px}
    .template-card{padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s}
    .template-card:hover{border-color:var(--emerald);background:var(--emerald-dim)}
    .template-card .t-name{font-size:13px;font-weight:600;margin-bottom:4px}
    .template-card .t-desc{font-size:11px;color:var(--muted)}
    .audit-table{width:100%;font-size:13px;border-collapse:collapse}
    .audit-table th{text-align:left;padding:10px 12px;border-bottom:1px solid var(--border);color:var(--muted);font-weight:500;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
    .audit-table td{padding:10px 12px;border-bottom:1px solid var(--border)}
    .audit-table tr:hover td{background:var(--surface)}
    .section-title{font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:16px;margin-bottom:16px}
    .agent-select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-size:13px;outline:none;cursor:pointer}
    .agent-select:focus{border-color:var(--emerald)}
    .header-controls{display:flex;align-items:center;gap:10px}
    .empty-state{text-align:center;padding:40px;color:var(--muted);font-size:14px}
    @media(max-width:768px){.sidebar{display:none}.app{flex-direction:column}}
  </style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">SC</div>
      <div class="sidebar-title">SecureClaw</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-label">Interface</div>
        <div class="nav-item active" onclick="switchPanel('chat')">
          <div class="nav-dot"></div>Chat
        </div>
        <div class="nav-item" onclick="switchPanel('agents')">
          <div class="nav-dot"></div>Agents
        </div>
        <div class="nav-item" onclick="switchPanel('tasks')">
          <div class="nav-dot"></div>Tasks
        </div>
        <div class="nav-item" onclick="switchPanel('audit')">
          <div class="nav-dot"></div>Audit Log
        </div>
      </div>
    </div>
    <div class="status-bar">
      <span class="status-dot online"></span>
      <span id="status-text">Connected</span>
    </div>
  </div>

  <div class="main">
    <div class="main-header">
      <div class="main-title" id="panel-title">
        Chat <span class="agent-badge" id="agent-label">orchestrator</span>
      </div>
      <div class="header-controls">
        <select class="agent-select" id="agent-select" onchange="onAgentChange()">
          <option value="orchestrator">Orchestrator</option>
          <option value="scheduler">Scheduler</option>
          <option value="research">Research</option>
          <option value="device">Device</option>
        </select>
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="panel active" id="panel-chat">
      <div class="chat-messages" id="chat-messages">
        <div class="welcome">
          <div class="welcome-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
          <h2>Secure Channel Open</h2>
          <p>Messages are processed by Grok 4 with multi-agent routing. Type anything to begin.</p>
        </div>
      </div>
      <div class="chat-input-area">
        <div class="chat-input-row">
          <textarea class="chat-input" id="chat-input" placeholder="Message SecureClaw..." rows="1" onkeydown="handleKey(event)"></textarea>
          <button class="send-btn" id="send-btn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Agents Panel -->
    <div class="panel" id="panel-agents">
      <div class="dashboard" id="agents-dashboard"></div>
    </div>

    <!-- Tasks Panel -->
    <div class="panel" id="panel-tasks">
      <div class="dashboard" id="tasks-dashboard"></div>
    </div>

    <!-- Audit Panel -->
    <div class="panel" id="panel-audit">
      <div class="dashboard" id="audit-dashboard"></div>
    </div>
  </div>
</div>

<script>
const BASE = window.location.origin;
let currentAgent = 'orchestrator';
let isStreaming = false;
let welcomeShown = true;

function switchPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.querySelectorAll('.nav-item')[['chat','agents','tasks','audit'].indexOf(name)].classList.add('active');
  const titles = {chat:'Chat',agents:'Agents',tasks:'Proactive Tasks',audit:'Audit Log'};
  document.getElementById('panel-title').innerHTML = titles[name] + (name==='chat'?' <span class="agent-badge" id="agent-label">'+currentAgent+'</span>':'');
  document.getElementById('agent-select').style.display = name==='chat'?'block':'none';
  if(name==='agents') loadAgents();
  if(name==='tasks') loadTasks();
  if(name==='audit') loadAudit();
}

function onAgentChange(){
  currentAgent = document.getElementById('agent-select').value;
  const lbl = document.getElementById('agent-label');
  if(lbl) lbl.textContent = currentAgent;
}

function handleKey(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
}

function addMessage(role, content, extra){
  if(welcomeShown){document.getElementById('chat-messages').innerHTML='';welcomeShown=false;}
  const div=document.createElement('div');
  div.className='msg '+role;
  let html='';
  if(extra?.agent) html+='<div class="agent-tag">'+extra.agent+'</div>';
  html+=escapeHtml(content);
  if(extra?.toolCalls?.length) html+='<div class="tool-tag">Tools: '+extra.toolCalls.map(t=>t.tool).join(', ')+'</div>';
  div.innerHTML=html;
  document.getElementById('chat-messages').appendChild(div);
  document.getElementById('chat-messages').scrollTop=document.getElementById('chat-messages').scrollHeight;
  return div;
}

function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function showTyping(){
  const d=document.createElement('div');d.className='typing';d.id='typing';
  d.innerHTML='<span></span><span></span><span></span>';
  document.getElementById('chat-messages').appendChild(d);
  document.getElementById('chat-messages').scrollTop=document.getElementById('chat-messages').scrollHeight;
}
function hideTyping(){const t=document.getElementById('typing');if(t)t.remove();}

const chatHistory=[];

async function sendMessage(){
  const input=document.getElementById('chat-input');
  const text=input.value.trim();
  if(!text||isStreaming)return;

  addMessage('user',text);
  chatHistory.push({role:'user',content:text});
  input.value='';input.style.height='auto';
  isStreaming=true;
  document.getElementById('send-btn').disabled=true;
  showTyping();

  let fullContent='';
  let assistantDiv=null;
  let toolCalls=[];
  let agent=currentAgent;

  try{
    const res=await fetch(BASE+'/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'text/event-stream'},
      body:JSON.stringify({messages:chatHistory,agent:currentAgent})
    });

    if(!res.ok) throw new Error('Server error: '+res.status);

    const reader=res.body.getReader();
    const decoder=new TextDecoder();
    let buffer='';

    while(true){
      const{done,value}=await reader.read();
      if(done)break;
      buffer+=decoder.decode(value,{stream:true});
      const lines=buffer.split('\n');
      buffer=lines.pop()||'';

      for(const line of lines){
        if(!line.startsWith('data: '))continue;
        const data=line.slice(6);
        if(data==='[DONE]')continue;
        try{
          const parsed=JSON.parse(data);
          if(parsed.error)throw new Error(parsed.error);
          if(parsed.toolCalls){toolCalls=parsed.toolCalls;if(parsed.agent)agent=parsed.agent;}
          if(parsed.content){
            fullContent+=parsed.content;
            hideTyping();
            if(!assistantDiv){
              assistantDiv=addMessage('assistant',fullContent,{agent});
            }else{
              let html='<div class="agent-tag">'+agent+'</div>'+escapeHtml(fullContent);
              assistantDiv.innerHTML=html;
            }
          }
        }catch(pe){if(pe.message&&!pe.message.includes('JSON'))throw pe;}
      }
    }

    if(toolCalls.length&&assistantDiv){
      assistantDiv.innerHTML+='<div class="tool-tag">Tools: '+toolCalls.map(t=>t.tool).join(', ')+'</div>';
    }
    if(fullContent) chatHistory.push({role:'assistant',content:fullContent});

  }catch(err){
    hideTyping();
    addMessage('error',err.message||'Connection error');
  }finally{
    isStreaming=false;
    document.getElementById('send-btn').disabled=false;
    hideTyping();
  }
}

async function loadAgents(){
  const dash=document.getElementById('agents-dashboard');
  try{
    const[agentsRes,healthRes]=await Promise.all([fetch(BASE+'/api/agents'),fetch(BASE+'/api/health')]);
    const agents=(await agentsRes.json()).agents;
    const health=await healthRes.json();
    let html='<div class="dash-grid">';
    agents.forEach(a=>{
      html+='<div class="card"><div class="card-title"><div class="dot"></div>'+a.role+'</div>';
      html+='<div class="card-body">'+a.description.split('.')[0]+'.<br><br>';
      html+='<strong>Proactive:</strong> '+(a.proactive?'Yes':'No')+'<br>';
      html+='<strong>Tools:</strong><div class="tool-list">'+a.tools.map(t=>'<span class="tool-chip">'+t+'</span>').join('')+'</div>';
      html+='</div></div>';
    });
    html+='</div>';
    html+='<div class="card"><div class="card-title">System Health</div><div class="card-body">';
    html+='<strong>Status:</strong> '+health.status+' | <strong>AI:</strong> '+health.ai+' | <strong>Proactive:</strong> '+(health.proactive?'Enabled':'Disabled');
    html+='</div></div>';
    dash.innerHTML=html;
  }catch(e){dash.innerHTML='<div class="empty-state">Failed to load agents: '+e.message+'</div>';}
}

async function loadTasks(){
  const dash=document.getElementById('tasks-dashboard');
  try{
    const[tasksRes,templatesRes]=await Promise.all([fetch(BASE+'/api/agents/tasks'),fetch(BASE+'/api/agents/tasks/templates')]);
    const tasks=(await tasksRes.json()).tasks;
    const templates=(await templatesRes.json()).templates;

    let html='<div class="section-title">Active Tasks</div>';
    if(tasks.length===0){
      html+='<div class="empty-state">No active tasks. Create one from templates below.</div>';
    }else{
      html+='<div class="task-list">';
      tasks.forEach(t=>{
        html+='<div class="task-item"><div class="task-info"><div class="task-name">'+escapeHtml(t.name)+'</div>';
        html+='<div class="task-cron">'+escapeHtml(t.cronExpression)+' | '+t.agent+'</div></div>';
        html+='<button class="run-btn" onclick="runTask(\''+t.id+'\')">Run Now</button></div>';
      });
      html+='</div>';
    }

    html+='<br><div class="section-title">Task Templates</div>';
    html+='<div class="template-grid">';
    templates.forEach(t=>{
      html+='<div class="template-card" onclick="createTask('+JSON.stringify(JSON.stringify(t))+')">';
      html+='<div class="t-name">'+escapeHtml(t.name)+'</div>';
      html+='<div class="t-desc">'+escapeHtml(t.description||t.prompt||'')+'</div></div>';
    });
    html+='</div>';
    dash.innerHTML=html;
  }catch(e){dash.innerHTML='<div class="empty-state">Failed to load tasks: '+e.message+'</div>';}
}

async function runTask(id){
  const btn=event.target;
  btn.disabled=true;btn.textContent='Running...';
  try{
    const res=await fetch(BASE+'/api/agents/tasks/'+id+'/run',{method:'POST'});
    const data=await res.json();
    btn.textContent='Done!';
    setTimeout(()=>{btn.textContent='Run Now';btn.disabled=false;},2000);
  }catch(e){btn.textContent='Error';setTimeout(()=>{btn.textContent='Run Now';btn.disabled=false;},2000);}
}

async function createTask(templateJson){
  try{
    const t=JSON.parse(templateJson);
    const res=await fetch(BASE+'/api/agents/tasks',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(t)
    });
    if(res.ok){loadTasks();}
    else{const d=await res.json();alert('Error: '+(d.error||'Failed'));}
  }catch(e){alert('Error creating task: '+e.message);}
}

async function loadAudit(){
  const dash=document.getElementById('audit-dashboard');
  try{
    const[logRes,statsRes]=await Promise.all([fetch(BASE+'/api/audit?limit=50'),fetch(BASE+'/api/audit/stats')]);
    const log=(await logRes.json()).log;
    const stats=await statsRes.json();

    let html='<div class="dash-grid">';
    html+='<div class="card"><div class="card-title">Total Actions</div><div class="card-body"><div class="stat">'+stats.total+'</div></div></div>';
    html+='<div class="card"><div class="card-title">Executed</div><div class="card-body"><div class="stat">'+stats.executed+'</div></div></div>';
    html+='<div class="card"><div class="card-title">Denied</div><div class="card-body"><div class="stat">'+(stats.denied||0)+'</div></div></div>';
    html+='</div>';

    if(log.length>0){
      html+='<br><div class="section-title">Recent Actions</div>';
      html+='<div style="overflow-x:auto"><table class="audit-table"><thead><tr><th>Time</th><th>Agent</th><th>Action</th><th>Tool</th><th>Status</th></tr></thead><tbody>';
      log.forEach(e=>{
        const time=e.timestamp?new Date(e.timestamp).toLocaleTimeString():'—';
        html+='<tr><td>'+time+'</td><td>'+escapeHtml(e.agent||'—')+'</td><td>'+escapeHtml(e.action||'—')+'</td><td>'+escapeHtml(e.tool||'—')+'</td><td>'+escapeHtml(e.status||'—')+'</td></tr>';
      });
      html+='</tbody></table></div>';
    }else{
      html+='<div class="empty-state">No audit entries yet.</div>';
    }
    dash.innerHTML=html;
  }catch(e){dash.innerHTML='<div class="empty-state">Failed to load audit: '+e.message+'</div>';}
}

document.getElementById('chat-input').addEventListener('input',function(){
  this.style.height='auto';
  this.style.height=Math.min(this.scrollHeight,120)+'px';
});

fetch(BASE+'/api/health').then(r=>r.json()).then(d=>{
  document.getElementById('status-text').textContent=d.status==='ok'?'Connected — Grok 4 '+d.ai:'Disconnected';
}).catch(()=>{document.getElementById('status-text').textContent='Offline';});
</script>
</body>
</html>
